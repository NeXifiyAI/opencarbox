name: ğŸ¥ Workflow Health Check

on:
  schedule:
    # Run every 6 hours to check workflow health
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  health-check:
    name: ğŸ“Š Check Workflow Health
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Analyze Recent Workflow Runs
        id: analyze
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            
            // Get workflow runs from last 24 hours
            const since = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              per_page: 100,
              created: `>=${since}`,
            });
            
            // Analyze runs
            const stats = {
              total: runs.workflow_runs.length,
              success: 0,
              failure: 0,
              cancelled: 0,
              in_progress: 0,
              failed_workflows: new Map(),
            };
            
            for (const run of runs.workflow_runs) {
              if (run.conclusion === 'success') stats.success++;
              else if (run.conclusion === 'failure') {
                stats.failure++;
                const name = run.name;
                stats.failed_workflows.set(name, (stats.failed_workflows.get(name) || 0) + 1);
              }
              else if (run.conclusion === 'cancelled') stats.cancelled++;
              else if (run.status === 'in_progress') stats.in_progress++;
            }
            
            // Calculate success rate
            const completed = stats.success + stats.failure + stats.cancelled;
            const successRate = completed > 0 ? ((stats.success / completed) * 100).toFixed(2) : 100;
            
            // Health status
            let health = 'ğŸŸ¢ Healthy';
            if (successRate < 50) health = 'ğŸ”´ Critical';
            else if (successRate < 75) health = 'ğŸŸ  Warning';
            else if (successRate < 90) health = 'ğŸŸ¡ Fair';
            
            // Output results
            core.setOutput('health', health);
            core.setOutput('success_rate', successRate);
            core.setOutput('total', stats.total);
            core.setOutput('failures', stats.failure);
            
            console.log('Health Check Results:');
            console.log(`Status: ${health}`);
            console.log(`Success Rate: ${successRate}%`);
            console.log(`Total Runs: ${stats.total}`);
            console.log(`Failures: ${stats.failure}`);
            
            // Create issue if health is poor
            if (successRate < 75) {
              const failedList = Array.from(stats.failed_workflows.entries())
                .sort((a, b) => b[1] - a[1])
                .map(([name, count]) => `- ${name}: ${count} failures`)
                .join('\n');
              
              const issueBody = `## ğŸš¨ Workflow Health Alert
              
**Status:** ${health}
**Success Rate:** ${successRate}%
**Time Period:** Last 24 hours

### ğŸ“Š Statistics
- Total Runs: ${stats.total}
- Successful: ${stats.success}
- Failed: ${stats.failure}
- Cancelled: ${stats.cancelled}
- In Progress: ${stats.in_progress}

### âš ï¸ Failed Workflows
${failedList || 'None'}

### ğŸ”§ Recommended Actions
1. Review and fix failing workflows
2. Check for dependency issues
3. Verify secrets and environment variables
4. Review recent code changes

---
*This is an automated health check. [View workflow runs](https://github.com/${owner}/${repo}/actions)*`;

              // Check if issue already exists
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                labels: 'workflow-health-alert',
                per_page: 1,
              });
              
              if (issues.length === 0) {
                await github.rest.issues.create({
                  owner,
                  repo,
                  title: `ğŸš¨ Workflow Health Alert: ${successRate}% Success Rate`,
                  body: issueBody,
                  labels: ['workflow-health-alert', 'urgent', 'automated'],
                });
                console.log('Created health alert issue');
              } else {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issues[0].number,
                  body: issueBody,
                });
                console.log('Updated existing health alert issue');
              }
            }

      - name: Report Status
        run: |
          echo "ğŸ¥ Workflow Health Check Complete"
          echo "Status: ${{ steps.analyze.outputs.health }}"
          echo "Success Rate: ${{ steps.analyze.outputs.success_rate }}%"
          echo "Total Runs: ${{ steps.analyze.outputs.total }}"
          echo "Failures: ${{ steps.analyze.outputs.failures }}"
