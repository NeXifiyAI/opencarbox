name: üöÄ System Integration Test

# Comprehensive test of the entire autonomous system
# Tests all components, scripts, and workflows

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test Mode'
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - scripts-only
          - workflows-only
  pull_request:
    paths:
      - '.github/workflows/**'
      - 'scripts/autonomous/**'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/enhanced-orchestrator.yml'
      - 'scripts/autonomous/**'

permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: '20'

jobs:
  # =================================================================
  # Test Autonomous Scripts
  # =================================================================
  test-scripts:
    name: üß™ Test Autonomous Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîç Verify Scripts Exist
        run: |
          echo "Checking for autonomous scripts..."
          
          REQUIRED_SCRIPTS=(
            "health-check.sh"
            "bot-lifecycle.sh"
            "self-heal.sh"
            "pipeline-optimizer.sh"
            "dashboard.sh"
            "monitor.sh"
            "recovery-templates.sh"
            "init-system.sh"
          )
          
          ALL_FOUND=true
          for script in "${REQUIRED_SCRIPTS[@]}"; do
            if [ -f "scripts/autonomous/$script" ]; then
              echo "‚úì $script found"
            else
              echo "‚úó $script missing"
              ALL_FOUND=false
            fi
          done
          
          if [ "$ALL_FOUND" = false ]; then
            echo "Error: Some scripts are missing"
            exit 1
          fi
          
          echo "All required scripts present ‚úì"

      - name: üîê Verify Script Permissions
        run: |
          echo "Checking script permissions..."
          
          for script in scripts/autonomous/*.sh; do
            if [ -x "$script" ]; then
              echo "‚úì $(basename "$script") is executable"
            else
              echo "‚úó $(basename "$script") is not executable"
              chmod +x "$script"
              echo "  Fixed: Made executable"
            fi
          done

      - name: üè• Test Health Check Script
        run: |
          echo "Testing health-check.sh..."
          bash scripts/autonomous/health-check.sh
          
          # Verify report was created
          if [ -f /tmp/health-check-report.json ]; then
            echo "‚úì Health check report generated"
            echo "Report contents:"
            cat /tmp/health-check-report.json | head -20
          else
            echo "‚úó Health check report not found"
            exit 1
          fi

      - name: ü§ñ Test Bot Lifecycle Script
        run: |
          echo "Testing bot-lifecycle.sh..."
          
          # Test list command
          bash scripts/autonomous/bot-lifecycle.sh list
          
          # Test status command for a specific bot
          bash scripts/autonomous/bot-lifecycle.sh status master-orchestrator || true
          
          echo "‚úì Bot lifecycle script works"

      - name: üìä Test Dashboard Generator
        run: |
          echo "Testing dashboard.sh..."
          bash scripts/autonomous/dashboard.sh
          
          # Verify dashboard was created
          if [ -f /tmp/bot-dashboard.md ]; then
            echo "‚úì Dashboard generated successfully"
            echo ""
            echo "Dashboard preview:"
            head -30 /tmp/bot-dashboard.md
          else
            echo "‚úó Dashboard not generated"
            exit 1
          fi

      - name: ‚ö° Test Pipeline Optimizer
        run: |
          echo "Testing pipeline-optimizer.sh..."
          bash scripts/autonomous/pipeline-optimizer.sh
          
          # Verify report was created
          if [ -f /tmp/pipeline-optimization-report.txt ]; then
            echo "‚úì Optimization report generated"
            echo ""
            echo "Report preview:"
            head -40 /tmp/pipeline-optimization-report.txt
          else
            echo "‚úó Optimization report not found"
            exit 1
          fi

      - name: üöë Test Recovery Templates
        run: |
          echo "Testing recovery-templates.sh..."
          bash scripts/autonomous/recovery-templates.sh
          
          # Verify templates were created
          if [ -d /tmp/recovery-templates ]; then
            echo "‚úì Recovery templates generated"
            ls -la /tmp/recovery-templates/
          else
            echo "‚úó Recovery templates not found"
            exit 1
          fi

      - name: üîß Test System Initialization
        run: |
          echo "Testing init-system.sh..."
          bash scripts/autonomous/init-system.sh
          
          # Verify initialization report
          if [ -f /tmp/autonomous-system-init-report.txt ]; then
            echo "‚úì Initialization completed"
            echo ""
            echo "Report preview:"
            cat /tmp/autonomous-system-init-report.txt | tail -40
          else
            echo "‚úó Initialization report not found"
            exit 1
          fi

      - name: üì§ Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: script-test-results
          path: |
            /tmp/health-check-report.json
            /tmp/bot-dashboard.md
            /tmp/pipeline-optimization-report.txt
            /tmp/recovery-templates/
            /tmp/autonomous-system-init-report.txt
          retention-days: 7

  # =================================================================
  # Test Workflow Files
  # =================================================================
  test-workflows:
    name: üìã Test Workflow Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîç Verify Workflow Files
        run: |
          echo "Checking workflow files..."
          
          CRITICAL_WORKFLOWS=(
            "enhanced-orchestrator.yml"
            "master-orchestrator.yml"
            "auto-pilot.yml"
            "full-autonomy.yml"
            "ai-self-healing.yml"
            "bot-maintenance.yml"
          )
          
          ALL_FOUND=true
          for workflow in "${CRITICAL_WORKFLOWS[@]}"; do
            if [ -f ".github/workflows/$workflow" ]; then
              echo "‚úì $workflow found"
            else
              echo "‚ö† $workflow not found (may be optional)"
            fi
          done
          
          TOTAL=$(find .github/workflows -name "*.yml" -type f | wc -l)
          echo ""
          echo "Total workflows: $TOTAL"

      - name: ‚úÖ Validate YAML Syntax
        run: |
          echo "Validating YAML syntax..."
          
          for workflow in .github/workflows/*.yml; do
            echo "Checking: $(basename "$workflow")"
            
            # Basic YAML validation - check if it can be parsed
            if grep -q "^name:" "$workflow" && grep -q "^on:" "$workflow"; then
              echo "  ‚úì Valid structure"
            else
              echo "  ‚ö† Possibly invalid structure"
            fi
          done

      - name: üîê Check Workflow Permissions
        run: |
          echo "Checking workflow permissions..."
          
          for workflow in .github/workflows/*.yml; do
            if grep -q "permissions:" "$workflow"; then
              echo "‚úì $(basename "$workflow"): Has permissions defined"
            else
              echo "‚ö† $(basename "$workflow"): No permissions defined"
            fi
          done

  # =================================================================
  # Test Documentation
  # =================================================================
  test-documentation:
    name: üìö Test Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üìÑ Verify Documentation Files
        run: |
          echo "Checking documentation files..."
          
          REQUIRED_DOCS=(
            ".github/AUTONOMOUS_CI_CD_CENTRAL.md"
            ".github/AUTONOMOUS_SYSTEM.md"
            "scripts/autonomous/README.md"
          )
          
          for doc in "${REQUIRED_DOCS[@]}"; do
            if [ -f "$doc" ]; then
              SIZE=$(stat -f%z "$doc" 2>/dev/null || stat -c%s "$doc")
              echo "‚úì $doc exists (${SIZE} bytes)"
            else
              echo "‚úó $doc missing"
            fi
          done

      - name: üîç Check Documentation Quality
        run: |
          echo "Checking documentation quality..."
          
          # Check main documentation
          if [ -f ".github/AUTONOMOUS_CI_CD_CENTRAL.md" ]; then
            LINES=$(wc -l < .github/AUTONOMOUS_CI_CD_CENTRAL.md)
            echo "‚úì AUTONOMOUS_CI_CD_CENTRAL.md: $LINES lines"
            
            # Check for key sections
            if grep -q "## üéØ Overview" .github/AUTONOMOUS_CI_CD_CENTRAL.md; then
              echo "  ‚úì Has Overview section"
            fi
            
            if grep -q "## üéØ Master Orchestrator Bot" .github/AUTONOMOUS_CI_CD_CENTRAL.md; then
              echo "  ‚úì Has Master Orchestrator section"
            fi
            
            if grep -q "## üöë Self-Healing System" .github/AUTONOMOUS_CI_CD_CENTRAL.md; then
              echo "  ‚úì Has Self-Healing section"
            fi
          fi

  # =================================================================
  # Integration Test Summary
  # =================================================================
  integration-summary:
    name: üìä Integration Test Summary
    runs-on: ubuntu-latest
    needs: [test-scripts, test-workflows, test-documentation]
    if: always()
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üìä Generate Summary
        run: |
          cat << 'EOF'
          
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë                                                                ‚ïë
          ‚ïë   ü§ñ  AUTONOMOUS SYSTEM INTEGRATION TEST RESULTS              ‚ïë
          ‚ïë                                                                ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          Test Results:
          EOF
          
          echo "  Scripts Test:        ${{ needs.test-scripts.result }}"
          echo "  Workflows Test:      ${{ needs.test-workflows.result }}"
          echo "  Documentation Test:  ${{ needs.test-documentation.result }}"
          echo ""
          
          if [ "${{ needs.test-scripts.result }}" = "success" ] && \
             [ "${{ needs.test-workflows.result }}" = "success" ] && \
             [ "${{ needs.test-documentation.result }}" = "success" ]; then
            echo "‚úÖ All tests passed! System is ready for deployment."
            echo ""
            echo "Next Steps:"
            echo "1. Review test artifacts"
            echo "2. Activate autonomous system"
            echo "3. Monitor for 24 hours"
            echo "4. Enable full autonomy"
          else
            echo "‚ö†Ô∏è  Some tests failed. Please review and fix issues."
          fi

      - name: üìã System Status
        if: success()
        run: |
          echo ""
          echo "üéØ Autonomous System Status:"
          echo "  ‚úÖ All scripts operational"
          echo "  ‚úÖ All workflows validated"
          echo "  ‚úÖ Documentation complete"
          echo "  ‚úÖ System ready for activation"
          echo ""
          echo "üöÄ To activate the system:"
          echo "   gh workflow run enhanced-orchestrator.yml -f command=activate-all-bots"
