name: ðŸ¤– AI Development Team

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for AI to perform'
        required: true
        type: string
      priority:
        description: 'Priority level'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  # ============================================================
  # AI Task Router - Entscheidet welche AI-Aktion nÃ¶tig ist
  # ============================================================
  ai-router:
    name: ðŸ§  AI Task Router
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.analyze.outputs.action }}
      branch: ${{ steps.analyze.outputs.branch }}
      task_type: ${{ steps.analyze.outputs.task_type }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Analyze Request
        id: analyze
        uses: actions/github-script@v7
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || '0' }}
          COMMENT_ID: ${{ github.event.comment.id || '0' }}
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels.*.name) }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
          TASK_INPUT: ${{ github.event.inputs.task || '' }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const event = context.eventName;
            const payload = context.payload;
            
            let action = 'none';
            let branch = 'main';
            let taskType = 'general';
            
            // Issue mit AI-Label
            if (event === 'issues' && payload.issue) {
              const labels = payload.issue.labels.map(l => l.name);
              if (labels.includes('ai-task') || labels.includes('ai-fix') || labels.includes('ai-feature')) {
                action = 'process_issue';
                branch = `ai/issue-${payload.issue.number}`;
                taskType = labels.includes('ai-fix') ? 'bugfix' : 'feature';
              }
            }
            
            // Comment mit @ai-team Trigger
            if (event === 'issue_comment' && payload.comment) {
              const body = payload.comment.body.toLowerCase();
              if (body.includes('@ai-team') || body.includes('@deepseek')) {
                action = 'process_comment';
                branch = `ai/comment-${payload.comment.id}`;
                taskType = 'comment_request';
              }
            }
            
            // PR Review Request
            if (event === 'pull_request') {
              action = 'review_pr';
              taskType = 'code_review';
            }
            
            // Manual Dispatch
            if (event === 'workflow_dispatch') {
              action = 'manual_task';
              branch = `ai/task-${Date.now()}`;
              taskType = 'manual';
            }
            
            core.setOutput('action', action);
            core.setOutput('branch', branch);
            core.setOutput('task_type', taskType);
            
            console.log(`Action: ${action}, Branch: ${branch}, Type: ${taskType}`);

  # ============================================================
  # AI Code Generator - Implementiert Features/Fixes
  # ============================================================
  ai-implement:
    name: ðŸ› ï¸ AI Implementation
    runs-on: ubuntu-latest
    needs: ai-router
    if: needs.ai-router.outputs.action == 'process_issue' || needs.ai-router.outputs.action == 'manual_task'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile || npm ci --legacy-peer-deps

      - name: Create AI Branch
        run: |
          git config user.name "NeXify AI Team"
          git config user.email "ai-team@nexifyai.com"
          git checkout -b ${{ needs.ai-router.outputs.branch }}

      - name: Get Task Details
        id: task
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            let taskDescription = '';
            let taskTitle = '';
            
            if (context.eventName === 'issues') {
              taskTitle = context.payload.issue.title;
              taskDescription = context.payload.issue.body || '';
            } else if (context.eventName === 'workflow_dispatch') {
              taskTitle = 'Manual AI Task';
              taskDescription = context.payload.inputs.task;
            }
            
            core.setOutput('title', taskTitle);
            core.setOutput('description', taskDescription);

      - name: AI Code Generation
        id: ai_code
        run: |
          cat > /tmp/ai_request.json << 'EOF'
          {
            "model": "deepseek-chat",
            "messages": [
              {
                "role": "system",
                "content": "Du bist ein Senior TypeScript/Next.js Entwickler im NeXify AI Team. Du arbeitest an OpenCarBox - einer Premium Automotive E-Commerce Plattform. Stack: Next.js 14, TypeScript strict, Supabase, TanStack Query, Tailwind CSS. WICHTIG: Antworte NUR mit dem JSON-Format fÃ¼r Code-Ã„nderungen. Keine ErklÃ¤rungen auÃŸerhalb des JSON."
              },
              {
                "role": "user",
                "content": "Task: ${{ steps.task.outputs.title }}\n\nBeschreibung:\n${{ steps.task.outputs.description }}\n\nErstelle die nÃ¶tigen Code-Ã„nderungen im folgenden JSON-Format:\n{\n  \"files\": [\n    {\n      \"path\": \"relativer/pfad/zur/datei.ts\",\n      \"action\": \"create|update|delete\",\n      \"content\": \"vollstÃ¤ndiger Dateiinhalt\"\n    }\n  ],\n  \"commit_message\": \"feat/fix: beschreibende commit message\",\n  \"pr_title\": \"PR Titel\",\n  \"pr_body\": \"PR Beschreibung mit Details\"\n}"
              }
            ],
            "temperature": 0.3,
            "max_tokens": 8192
          }
          EOF
          
          RESPONSE=$(curl -s -X POST "https://api.deepseek.com/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DEEPSEEK_API_KEY }}" \
            -d @/tmp/ai_request.json)
          
          echo "$RESPONSE" > /tmp/ai_response.json
          
          # Extract content from response
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$CONTENT" ]; then
            echo "Error: No content in AI response"
            echo "$RESPONSE"
            exit 1
          fi
          
          echo "$CONTENT" > /tmp/ai_changes.json
          echo "ai_response<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Apply Code Changes
        run: |
          node << 'SCRIPT'
          const fs = require('fs');
          const path = require('path');
          
          try {
            const changesRaw = fs.readFileSync('/tmp/ai_changes.json', 'utf8');
            // Extract JSON from potential markdown code blocks
            let jsonContent = changesRaw;
            const jsonMatch = changesRaw.match(/```(?:json)?\s*([\s\S]*?)```/);
            if (jsonMatch) {
              jsonContent = jsonMatch[1].trim();
            }
            
            const changes = JSON.parse(jsonContent);
            
            if (!changes.files || !Array.isArray(changes.files)) {
              console.log('No files to change');
              process.exit(0);
            }
            
            for (const file of changes.files) {
              const filePath = path.resolve(file.path);
              const dir = path.dirname(filePath);
              
              if (file.action === 'delete') {
                if (fs.existsSync(filePath)) {
                  fs.unlinkSync(filePath);
                  console.log(`Deleted: ${file.path}`);
                }
              } else {
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                fs.writeFileSync(filePath, file.content);
                console.log(`${file.action === 'create' ? 'Created' : 'Updated'}: ${file.path}`);
              }
            }
            
            // Save PR info
            fs.writeFileSync('/tmp/pr_info.json', JSON.stringify({
              title: changes.pr_title || 'AI: Code Changes',
              body: changes.pr_body || 'Automated changes by AI Team',
              commit: changes.commit_message || 'chore: ai code changes'
            }));
            
          } catch (error) {
            console.error('Error applying changes:', error.message);
            process.exit(1);
          }
          SCRIPT

      - name: Commit & Push
        id: commit
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PR_INFO=$(cat /tmp/pr_info.json 2>/dev/null || echo '{"commit":"chore: ai changes"}')
          COMMIT_MSG=$(echo "$PR_INFO" | jq -r '.commit // "chore: ai changes"')
          
          git commit -m "$COMMIT_MSG"
          git push -u origin ${{ needs.ai-router.outputs.branch }}
          
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.commit.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const fs = require('fs');
            let prInfo = { title: 'AI: Code Changes', body: 'Automated changes' };
            
            try {
              prInfo = JSON.parse(fs.readFileSync('/tmp/pr_info.json', 'utf8'));
            } catch (e) {
              console.log('Using default PR info');
            }
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prInfo.title,
              body: prInfo.body + '\n\n---\nðŸ¤– *Automated by NeXify AI Team using DeepSeek*',
              head: '${{ needs.ai-router.outputs.branch }}',
              base: 'main'
            });
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ai-generated', 'auto-review']
            });
            
            // Link to original issue if applicable
            if (context.eventName === 'issues') {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `ðŸ¤– AI Team hat einen PR erstellt: #${pr.number}`
              });
            }
            
            console.log(`Created PR #${pr.number}`);

  # ============================================================
  # AI Code Review - PrÃ¼ft PRs automatisch
  # ============================================================
  ai-review:
    name: ðŸ” AI Code Review
    runs-on: ubuntu-latest
    needs: ai-router
    if: needs.ai-router.outputs.action == 'review_pr'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: diff
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { data: diff } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              mediaType: { format: 'diff' }
            });
            
            // Truncate if too long
            const maxLength = 10000;
            const truncatedDiff = diff.length > maxLength 
              ? diff.substring(0, maxLength) + '\n... (truncated)'
              : diff;
            
            core.setOutput('content', truncatedDiff);

      - name: AI Review
        id: review
        run: |
          cat > /tmp/review_request.json << 'EOF'
          {
            "model": "deepseek-chat",
            "messages": [
              {
                "role": "system",
                "content": "Du bist ein erfahrener Code-Reviewer. Analysiere den PR-Diff und gib konstruktives Feedback. Fokussiere auf: 1) Bugs & Sicherheit, 2) Performance, 3) Best Practices, 4) TypeScript Typisierung. Antworte auf Deutsch. Format: ## Zusammenfassung\n...\n## Kritische Issues\n...\n## VerbesserungsvorschlÃ¤ge\n...\n## Fazit\n[APPROVE/REQUEST_CHANGES/COMMENT]"
              },
              {
                "role": "user",
                "content": "Review diesen PR:\n\nTitel: ${{ github.event.pull_request.title }}\n\nDiff:\n${{ steps.diff.outputs.content }}"
              }
            ],
            "temperature": 0.2,
            "max_tokens": 4096
          }
          EOF
          
          RESPONSE=$(curl -s -X POST "https://api.deepseek.com/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DEEPSEEK_API_KEY }}" \
            -d @/tmp/review_request.json)
          
          REVIEW=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Review konnte nicht erstellt werden."')
          
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const review = `${{ steps.review.outputs.review }}`;
            
            // Determine review action
            let event = 'COMMENT';
            if (review.includes('[APPROVE]')) {
              event = 'APPROVE';
            } else if (review.includes('[REQUEST_CHANGES]')) {
              event = 'REQUEST_CHANGES';
            }
            
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: 'ðŸ¤– **AI Code Review (DeepSeek)**\n\n' + review,
              event: event
            });

  # ============================================================
  # AI Comment Handler - Reagiert auf @ai-team Mentions
  # ============================================================
  ai-comment:
    name: ðŸ’¬ AI Comment Response
    runs-on: ubuntu-latest
    needs: ai-router
    if: needs.ai-router.outputs.action == 'process_comment'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const issueNumber = context.payload.issue.number;
            
            // Extract question/request after @ai-team
            const request = comment.replace(/@ai-team|@deepseek/gi, '').trim();
            
            // Call DeepSeek
            const response = await fetch('https://api.deepseek.com/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${{ secrets.DEEPSEEK_API_KEY }}`
              },
              body: JSON.stringify({
                model: 'deepseek-chat',
                messages: [
                  {
                    role: 'system',
                    content: 'Du bist ein hilfreicher AI-Assistent im NeXify Development Team. Antworte prÃ¤zise und hilfreich auf Deutsch. Bei Code-Fragen, zeige Beispiele.'
                  },
                  {
                    role: 'user',
                    content: request
                  }
                ],
                temperature: 0.5,
                max_tokens: 2048
              })
            });
            
            const data = await response.json();
            const aiResponse = data.choices?.[0]?.message?.content || 'Entschuldigung, ich konnte keine Antwort generieren.';
            
            // Post reply
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ¤– **AI Team Response:**\n\n${aiResponse}\n\n---\n*Powered by DeepSeek AI*`
            });
