name: ðŸŽ¯ Master Orchestrator Bot

# Master Bot - Zentrale Steuerung des gesamten AI-Teams
# EmpfÃ¤ngt alle Events, koordiniert alle Bots, Ã¼berwacht Projektfortschritt

on:
  # EmpfÃ¤ngt ALLE wichtigen Events
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, synchronize, closed, reopened, labeled, unlabeled, ready_for_review]
  pull_request_review:
    types: [submitted, edited, dismissed]
  push:
    branches:
      - main
      - develop
  workflow_run:
    workflows: ["ðŸ¤– QA-Bot (Quality & Fixes)", "ðŸ›¡ï¸ Security-Bot (Vulnerability Check)", "ðŸš€ DevOps-Bot (Build, Deploy & Optimize)"]
    types: [completed]
  schedule:
    # TÃ¤glich um 6:00 UTC - Projekt-Health-Check
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      command:
        description: 'Master Bot Command'
        required: true
        type: choice
        options:
          - health-check
          - complete-project
          - analyze-status
          - fix-all-issues
          - deploy-all
          - restart-bot
          - optimize-bots
          - fix-pipeline
          - optimize-pipeline
          - expand-pipeline
          - emergency-fix
      target_bot:
        description: 'Target Bot (for restart/optimize)'
        required: false
        type: choice
        options:
          - all
          - qa-bot
          - security-bot
          - devops-bot
          - ai-team
          - ai-auto-merge
          - ai-self-healing
      priority:
        description: 'Priority Level'
        default: 'high'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  checks: write
  deployments: write
  security-events: write
  statuses: write
  workflows: write
  packages: write
  repository-projects: write

env:
  MASTER_BOT_TOKEN: ${{ secrets.GH_TOKEN }}
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ============================================================
  # Master Control - Zentrale Entscheidungsinstanz
  # ============================================================
  master-control:
    name: ðŸŽ¯ Master Control Center
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.decide.outputs.action }}
      priority: ${{ steps.decide.outputs.priority }}
      tasks: ${{ steps.decide.outputs.tasks }}
      bot_assignments: ${{ steps.decide.outputs.bot_assignments }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Analyze Project State
        id: analyze
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const eventName = context.eventName;
            const payload = context.payload;
            
            console.log(`ðŸŽ¯ Master Bot aktiviert durch Event: ${eventName}`);
            
            // Sammle alle relevanten Projekt-Informationen
            const projectState = {
              event: eventName,
              timestamp: new Date().toISOString(),
              repository: context.repo,
              issues: { open: 0, critical: 0 },
              prs: { open: 0, mergeable: 0, blocked: 0 },
              workflows: { failing: 0, successful: 0 },
              health: 'unknown'
            };
            
            // Hole offene Issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            projectState.issues.open = issues.filter(i => !i.pull_request).length;
            projectState.issues.critical = issues.filter(i => 
              i.labels.some(l => l.name.includes('critical') || l.name.includes('bug'))
            ).length;
            
            // Hole offene PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            projectState.prs.open = prs.length;
            projectState.prs.mergeable = prs.filter(pr => pr.mergeable_state === 'clean').length;
            projectState.prs.blocked = prs.filter(pr => 
              pr.mergeable_state === 'blocked' || pr.draft
            ).length;
            
            // Hole letzte Workflow-Runs
            const { data: workflows } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 20
            });
            
            projectState.workflows.failing = workflows.workflow_runs.filter(
              w => w.conclusion === 'failure'
            ).length;
            projectState.workflows.successful = workflows.workflow_runs.filter(
              w => w.conclusion === 'success'
            ).length;
            
            // Berechne Projekt-Health
            const healthScore = (
              (projectState.workflows.successful / Math.max(workflows.workflow_runs.length, 1)) * 40 +
              (1 - projectState.issues.critical / Math.max(projectState.issues.open, 1)) * 30 +
              (projectState.prs.mergeable / Math.max(projectState.prs.open, 1)) * 30
            );
            
            projectState.health = healthScore > 80 ? 'excellent' : 
                                 healthScore > 60 ? 'good' : 
                                 healthScore > 40 ? 'fair' : 'critical';
            
            console.log('ðŸ“Š Projekt-Status:', JSON.stringify(projectState, null, 2));
            
            core.setOutput('project_state', JSON.stringify(projectState));
            core.setOutput('health_score', healthScore.toFixed(2));
            core.setOutput('health', projectState.health);
            
            return projectState;

      - name: Master Decision Engine
        id: decide
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const projectState = JSON.parse('${{ steps.analyze.outputs.project_state }}');
            const event = context.eventName;
            const health = '${{ steps.analyze.outputs.health }}';
            
            let action = 'monitor';
            let priority = 'medium';
            let tasks = [];
            let botAssignments = {};
            
            console.log(`ðŸ§  Master Decision Engine - Health: ${health}`);
            
            // Event-basierte Entscheidungen
            if (event === 'workflow_dispatch') {
              const command = context.payload.inputs?.command || 'health-check';
              action = command;
              priority = context.payload.inputs?.priority || 'high';
              
              if (command === 'complete-project') {
                tasks = [
                  'analyze_missing_features',
                  'fix_all_bugs',
                  'complete_documentation',
                  'optimize_performance',
                  'ensure_security',
                  'validate_quality'
                ];
                botAssignments = {
                  'qa-bot': ['fix_all_bugs', 'validate_quality'],
                  'security-bot': ['ensure_security'],
                  'devops-bot': ['optimize_performance'],
                  'ai-team': ['analyze_missing_features', 'complete_documentation']
                };
              } else if (command === 'fix-all-issues') {
                tasks = ['triage_issues', 'assign_to_bots', 'track_progress'];
              }
            }
            
            // Workflow-Fehler
            if (event === 'workflow_run' && context.payload.workflow_run?.conclusion === 'failure') {
              action = 'fix_workflow_failure';
              priority = 'high';
              tasks = ['diagnose_failure', 'create_fix_pr', 'monitor_fix'];
              botAssignments = {
                'ai-team': ['diagnose_failure', 'create_fix_pr']
              };
            }
            
            // Neue Issues
            if (event === 'issues' && context.payload.action === 'opened') {
              action = 'triage_issue';
              const labels = context.payload.issue?.labels?.map(l => l.name) || [];
              priority = labels.includes('critical') ? 'critical' : 
                         labels.includes('bug') ? 'high' : 'medium';
              tasks = ['analyze_issue', 'assign_bot', 'create_implementation_plan'];
            }
            
            // Neue PRs
            if (event === 'pull_request' && context.payload.action === 'opened') {
              action = 'review_pr';
              tasks = ['code_review', 'security_scan', 'quality_check'];
              botAssignments = {
                'ai-team': ['code_review'],
                'security-bot': ['security_scan'],
                'qa-bot': ['quality_check']
              };
            }
            
            // Health-Check bei kritischem Status
            if (health === 'critical') {
              action = 'emergency_intervention';
              priority = 'critical';
              tasks = ['fix_critical_issues', 'restore_stability', 'alert_team'];
            }
            
            // TÃ¤glicher Health-Check
            if (event === 'schedule') {
              action = 'daily_health_check';
              tasks = ['analyze_metrics', 'identify_improvements', 'create_tasks'];
            }
            
            core.setOutput('action', action);
            core.setOutput('priority', priority);
            core.setOutput('tasks', JSON.stringify(tasks));
            core.setOutput('bot_assignments', JSON.stringify(botAssignments));
            
            console.log(`âœ… Entscheidung: ${action} (PrioritÃ¤t: ${priority})`);
            console.log(`ðŸ“‹ Aufgaben:`, tasks);
            console.log(`ðŸ¤– Bot-Zuweisungen:`, botAssignments);

      - name: Create Master Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const projectState = JSON.parse('${{ steps.analyze.outputs.project_state }}');
            const health = '${{ steps.analyze.outputs.health }}';
            const healthScore = '${{ steps.analyze.outputs.health_score }}';
            const action = '${{ steps.decide.outputs.action }}';
            const tasks = JSON.parse('${{ steps.decide.outputs.tasks }}');
            
            const report = `## ðŸŽ¯ Master Bot Status Report
            
            **Zeitstempel:** ${new Date().toISOString()}
            **Event:** ${context.eventName}
            **Projekt-Health:** ${health} (${healthScore}/100)
            **Aktion:** ${action}
            
            ### ðŸ“Š Projekt-Metriken
            
            | Kategorie | Status |
            |-----------|--------|
            | ðŸ› Offene Issues | ${projectState.issues.open} (${projectState.issues.critical} kritisch) |
            | ðŸ”€ Offene PRs | ${projectState.prs.open} (${projectState.prs.mergeable} ready) |
            | âœ… Workflows | ${projectState.workflows.successful} erfolgreich, ${projectState.workflows.failing} fehlgeschlagen |
            
            ### ðŸŽ¯ Geplante Aktionen
            ${tasks.map(t => `- [ ] ${t}`).join('\n')}
            
            ---
            *Generiert von Master Orchestrator Bot*`;
            
            console.log(report);
            
            // Speichere Report als Artifact
            const fs = require('fs');
            fs.writeFileSync('/tmp/master-report.md', report);

      - name: Upload Master Report
        uses: actions/upload-artifact@v4
        with:
          name: master-bot-report-${{ github.run_id }}
          path: /tmp/master-report.md
          retention-days: 30

  # ============================================================
  # Task Executor - FÃ¼hrt Master-Entscheidungen aus
  # ============================================================
  execute-tasks:
    name: ðŸš€ Execute Master Tasks
    runs-on: ubuntu-latest
    needs: master-control
    if: needs.master-control.outputs.action != 'monitor'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: Setup Environment
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      - name: Execute Action
        id: execute
        uses: actions/github-script@v7
        env:
          ACTION: ${{ needs.master-control.outputs.action }}
          TASKS: ${{ needs.master-control.outputs.tasks }}
          BOT_ASSIGNMENTS: ${{ needs.master-control.outputs.bot_assignments }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const action = process.env.ACTION;
            const tasks = JSON.parse(process.env.TASKS || '[]');
            const botAssignments = JSON.parse(process.env.BOT_ASSIGNMENTS || '{}');
            
            console.log(`ðŸš€ Executing: ${action}`);
            
            // Projekt-VervollstÃ¤ndigung
            if (action === 'complete-project') {
              console.log('ðŸŽ¯ Starte Projekt-VervollstÃ¤ndigung...');
              
              // 1. Analysiere fehlende Features anhand von project.config.ts
              const fs = require('fs');
              const configPath = 'project.config.ts';
              
              if (fs.existsSync(configPath)) {
                const configContent = fs.readFileSync(configPath, 'utf8');
                console.log('ðŸ“‹ Projekt-Konfiguration gefunden');
                
                // Erstelle Issue fÃ¼r fehlende Features
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'ðŸŽ¯ Master Bot: Projekt-VervollstÃ¤ndigung gestartet',
                  body: `## Automatische Projekt-Analyse
                  
                  Der Master Bot hat eine vollstÃ¤ndige Projekt-Analyse gestartet.
                  
                  ### ðŸŽ¯ Ziel
                  VervollstÃ¤ndigung aller Features gemÃ¤ÃŸ project.config.ts
                  
                  ### ðŸ“‹ Aufgaben
                  ${tasks.map(t => `- [ ] ${t}`).join('\n')}
                  
                  ### ðŸ¤– Bot-Zuweisungen
                  ${Object.entries(botAssignments).map(([bot, tasks]) => 
                    `- **${bot}**: ${tasks.join(', ')}`
                  ).join('\n')}
                  
                  ---
                  Der Master Bot wird die Fortschritte Ã¼berwachen und koordinieren.`,
                  labels: ['master-bot', 'auto-completion', 'high-priority']
                });
              }
              
              // 2. Triggere spezialisierte Bots
              for (const [bot, botTasks] of Object.entries(botAssignments)) {
                console.log(`ðŸ“¤ Delegiere an ${bot}: ${botTasks.join(', ')}`);
                // Hier kÃ¶nnte man workflow_dispatch fÃ¼r die spezifischen Bots triggern
              }
            }
            
            // Workflow-Fehler beheben
            if (action === 'fix_workflow_failure') {
              const workflowRun = context.payload.workflow_run;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Master Bot: Workflow-Fehler in ${workflowRun.name}`,
                body: `## Automatische Fehleranalyse
                
                **Workflow:** ${workflowRun.name}
                **Run ID:** ${workflowRun.id}
                **Branch:** ${workflowRun.head_branch}
                
                Der Master Bot hat einen Workflow-Fehler erkannt und delegiert die Behebung an das AI-Team.
                
                [Workflow Run anzeigen](${workflowRun.html_url})`,
                labels: ['bug', 'workflow-failure', 'ai-task', 'master-bot']
              });
            }
            
            // Issue-Triage
            if (action === 'triage_issue') {
              const issue = context.payload.issue;
              const labels = issue.labels.map(l => l.name);
              
              // Intelligente Label-Zuweisung
              const aiLabels = ['ai-task'];
              if (labels.includes('bug')) {
                aiLabels.push('ai-fix');
              } else if (labels.includes('enhancement')) {
                aiLabels.push('ai-feature');
              }
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: aiLabels
              });
              
              // Kommentar mit Analyse
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ðŸŽ¯ **Master Bot Analyse**
                
                Dieses Issue wurde vom Master Bot analysiert und kategorisiert.
                
                **PrioritÃ¤t:** ${labels.includes('critical') ? 'ðŸ”´ Kritisch' : labels.includes('bug') ? 'ðŸŸ¡ Hoch' : 'ðŸŸ¢ Normal'}
                **Zugewiesen an:** AI Development Team
                
                Das AI-Team wird sich zeitnah darum kÃ¼mmern.`
              });
            }
            
            // PR Review
            if (action === 'review_pr') {
              const pr = context.payload.pull_request;
              
              // Triggere alle Review-Bots
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸŽ¯ **Master Bot aktiviert**
                
                Der Master Bot hat folgende PrÃ¼fungen initiiert:
                - âœ… Code Review (AI Team)
                - ðŸ”’ Security Scan (Security Bot)
                - ðŸ§ª Quality Check (QA Bot)
                
                Die Ergebnisse folgen in KÃ¼rze.`
              });
            }
            
            // TÃ¤glicher Health-Check
            if (action === 'daily_health_check') {
              console.log('ðŸ“Š FÃ¼hre tÃ¤glichen Health-Check durch...');
              
              // Erstelle tÃ¤glichen Status-Report als Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“Š TÃ¤glicher Projekt-Status ${new Date().toISOString().split('T')[0]}`,
                body: `## Automatischer Tages-Report
                
                Der Master Bot hat den Projekt-Status analysiert.
                
                ### ðŸ“‹ Aufgaben
                ${tasks.map(t => `- [ ] ${t}`).join('\n')}
                
                Dieser Report wird automatisch tÃ¤glich erstellt.`,
                labels: ['master-bot', 'daily-report', 'automated']
              });
            }
            
            console.log('âœ… Aktion erfolgreich ausgefÃ¼hrt');
            
            // ADMIN COMMANDS - Bot-Management
            if (action === 'restart-bot' || action === 'optimize-bots') {
              const targetBot = context.payload.inputs?.target_bot || 'all';
              console.log(`ðŸ”„ ${action === 'restart-bot' ? 'Neustart' : 'Optimierung'} von: ${targetBot}`);
              
              const botWorkflows = {
                'qa-bot': 'qa-bot.yml',
                'security-bot': 'security-bot.yml',
                'devops-bot': 'devops-bot.yml',
                'ai-team': 'ai-team.yml',
                'ai-auto-merge': 'ai-auto-merge.yml',
                'ai-self-healing': 'ai-self-healing.yml'
              };
              
              const botsToProcess = targetBot === 'all' ? Object.keys(botWorkflows) : [targetBot];
              
              for (const bot of botsToProcess) {
                const workflowFile = botWorkflows[bot];
                
                if (action === 'restart-bot') {
                  // Triggere Workflow neu
                  try {
                    // Hole Workflow-ID
                    const { data: workflows } = await github.rest.actions.listRepoWorkflows({
                      owner: context.repo.owner,
                      repo: context.repo.repo
                    });
                    
                    const workflow = workflows.workflows.find(w => w.path.includes(workflowFile));
                    
                    if (workflow) {
                      await github.rest.actions.createWorkflowDispatch({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        workflow_id: workflow.id,
                        ref: 'main'
                      });
                      console.log(`âœ… ${bot} wurde neu gestartet`);
                    }
                  } catch (e) {
                    console.log(`âš ï¸ Konnte ${bot} nicht neu starten: ${e.message}`);
                  }
                }
                
                if (action === 'optimize-bots') {
                  // Erstelle Optimierungs-Issue
                  await github.rest.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: `ðŸ”§ Master Bot: Optimierung von ${bot}`,
                    body: `## Bot-Optimierung durch Master Bot
                    
                    **Bot:** ${bot}
                    **Workflow:** ${workflowFile}
                    
                    Der Master Bot hat eine Optimierung initiiert.
                    
                    ### ðŸŽ¯ Optimierungsziele
                    - [ ] Performance-Verbesserungen
                    - [ ] Fehlertoleranz erhÃ¶hen
                    - [ ] Ressourcenverbrauch reduzieren
                    - [ ] Caching optimieren
                    - [ ] Timeout-Einstellungen anpassen
                    
                    ### ðŸ¤– AI-Analyse lÃ¤uft...
                    
                    Der Master Bot wird automatisch einen PR mit Verbesserungen erstellen.`,
                    labels: ['master-bot', 'bot-optimization', 'automation']
                  });
                }
              }
            }
            
            // ADMIN COMMANDS - Pipeline-Management
            if (action === 'fix-pipeline' || action === 'optimize-pipeline' || action === 'expand-pipeline') {
              console.log(`ðŸ”§ Pipeline-${action}: Starte...`);
              
              const pipelineAction = action.replace('-pipeline', '');
              
              // Erstelle Branch fÃ¼r Pipeline-Ã„nderungen
              const branchName = `master-bot/pipeline-${pipelineAction}-${Date.now()}`;
              
              try {
                // Hole aktuellen main SHA
                const { data: mainRef } = await github.rest.git.getRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: 'heads/main'
                });
                
                // Erstelle neuen Branch
                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/heads/${branchName}`,
                  sha: mainRef.object.sha
                });
                
                console.log(`âœ… Branch erstellt: ${branchName}`);
                
                // Erstelle Issue fÃ¼r Pipeline-Arbeit
                const { data: issue } = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸ”§ Master Bot: Pipeline ${pipelineAction}`,
                  body: `## Automatische Pipeline-${pipelineAction}
                  
                  **Branch:** \`${branchName}\`
                  **Aktion:** ${action}
                  
                  Der Master Bot arbeitet an der CI/CD Pipeline.
                  
                  ### ðŸŽ¯ Ziele
                  ${action === 'fix-pipeline' ? `
                  - [ ] Workflow-Fehler identifizieren
                  - [ ] Syntax-Probleme beheben
                  - [ ] Fehlende Dependencies ergÃ¤nzen
                  - [ ] Action-Versionen aktualisieren
                  ` : action === 'optimize-pipeline' ? `
                  - [ ] Workflow-Performance verbessern
                  - [ ] Parallelisierung optimieren
                  - [ ] Caching-Strategien verbessern
                  - [ ] Ressourcen-Nutzung reduzieren
                  ` : `
                  - [ ] Neue Workflows hinzufÃ¼gen
                  - [ ] Best Practices implementieren
                  - [ ] Monitoring verbessern
                  - [ ] Automatisierung erweitern
                  `}
                  
                  ### ðŸ¤– Status
                  - [x] Branch erstellt
                  - [ ] Analyse lÃ¤uft
                  - [ ] PR wird erstellt
                  
                  Ein Pull Request wird automatisch erstellt.`,
                  labels: ['master-bot', 'pipeline', 'automation', 'critical']
                });
                
                console.log(`âœ… Issue #${issue.number} erstellt`);
                
                // Label fÃ¼r AI-Team hinzufÃ¼gen, damit es den Task Ã¼bernimmt
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['ai-task', 'ai-fix']
                });
                
              } catch (e) {
                console.error(`âŒ Fehler bei Pipeline-${pipelineAction}:`, e.message);
              }
            }
            
            // EMERGENCY FIX - Sofortige Intervention
            if (action === 'emergency-fix') {
              console.log('ðŸš¨ NOTFALL-MODUS AKTIVIERT');
              
              // Analysiere alle fehlgeschlagenen Workflows
              const { data: failedRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                status: 'failure',
                per_page: 10
              });
              
              console.log(`ðŸ” Gefunden: ${failedRuns.workflow_runs.length} fehlgeschlagene Workflows`);
              
              for (const run of failedRuns.workflow_runs.slice(0, 5)) {
                // Erstelle Fix-Issue fÃ¼r jeden fehlgeschlagenen Workflow
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸš¨ NOTFALL: ${run.name} fehlgeschlagen`,
                  body: `## Automatische Notfall-Intervention
                  
                  **Workflow:** ${run.name}
                  **Run ID:** ${run.id}
                  **Branch:** ${run.head_branch}
                  **Fehler-Zeit:** ${run.updated_at}
                  
                  [Workflow Run anzeigen](${run.html_url})
                  
                  Der Master Bot hat diesen kritischen Fehler erkannt und weist das AI-Team an, ihn sofort zu beheben.
                  
                  ### âš¡ PrioritÃ¤t: KRITISCH
                  
                  @ai-team Bitte sofort beheben!`,
                  labels: ['critical', 'bug', 'workflow-failure', 'ai-task', 'ai-fix', 'master-bot']
                });
              }
            }

  # ============================================================
  # AI Coordination - DeepSeek Integration fÃ¼r komplexe Entscheidungen
  # ============================================================
  ai-coordination:
    name: ðŸ§  AI-Powered Coordination
    runs-on: ubuntu-latest
    needs: [master-control, execute-tasks]
    if: |
      needs.master-control.outputs.priority == 'critical' ||
      needs.master-control.outputs.action == 'complete-project'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: AI Strategy Planning
        id: ai_plan
        run: |
          cat > /tmp/master_request.json << 'EOF'
          {
            "model": "deepseek-chat",
            "messages": [
              {
                "role": "system",
                "content": "Du bist der Master AI Coordinator fÃ¼r das OpenCarBox Projekt. Deine Aufgabe ist es, das gesamte Entwicklungsteam zu koordinieren und sicherzustellen, dass alle Features gemÃ¤ÃŸ der Projektvorgaben implementiert werden. Analysiere den aktuellen Status und erstelle einen detaillierten Aktionsplan."
              },
              {
                "role": "user",
                "content": "Projekt: OpenCarBox - Premium Automotive E-Commerce Platform\nStack: Next.js 15, TypeScript, Supabase, Vercel\n\nAktuelle Situation:\n- Event: ${{ github.event_name }}\n- Action: ${{ needs.master-control.outputs.action }}\n- Priority: ${{ needs.master-control.outputs.priority }}\n- Tasks: ${{ needs.master-control.outputs.tasks }}\n\nErstelle einen detaillierten Koordinationsplan im JSON-Format:\n{\n  \"analysis\": \"Situationsanalyse\",\n  \"strategy\": \"Gesamtstrategie\",\n  \"bot_instructions\": {\n    \"qa-bot\": \"Anweisungen\",\n    \"security-bot\": \"Anweisungen\",\n    \"devops-bot\": \"Anweisungen\",\n    \"ai-team\": \"Anweisungen\"\n  },\n  \"timeline\": \"Zeitplan\",\n  \"success_criteria\": [\"Kriterium 1\", \"Kriterium 2\"]\n}"
              }
            ],
            "temperature": 0.3,
            "max_tokens": 4096
          }
          EOF
          
          RESPONSE=$(curl -s -X POST "https://api.deepseek.com/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.DEEPSEEK_API_KEY }}" \
            -d @/tmp/master_request.json)
          
          PLAN=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "{}"')
          
          echo "$PLAN" > /tmp/master_plan.json
          echo "Master AI Plan erstellt"

      - name: Execute AI Plan
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const fs = require('fs');
            
            let plan = { analysis: 'Plan konnte nicht erstellt werden' };
            try {
              const planContent = fs.readFileSync('/tmp/master_plan.json', 'utf8');
              // Extract JSON from potential markdown code blocks
              const jsonMatch = planContent.match(/```(?:json)?\s*([\s\S]*?)```/);
              const jsonContent = jsonMatch ? jsonMatch[1].trim() : planContent;
              plan = JSON.parse(jsonContent);
            } catch (e) {
              console.log('Fehler beim Parsen des AI-Plans:', e.message);
            }
            
            // Erstelle strategisches Issue mit dem Plan
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ§  Master Bot: AI-Koordinationsplan',
              body: `## Master AI Coordination Plan
              
              **Erstellt:** ${new Date().toISOString()}
              
              ### ðŸ“Š Analyse
              ${plan.analysis || 'N/A'}
              
              ### ðŸŽ¯ Strategie
              ${plan.strategy || 'N/A'}
              
              ### ðŸ¤– Bot-Anweisungen
              ${plan.bot_instructions ? Object.entries(plan.bot_instructions).map(([bot, instruction]) => 
                `**${bot}:**\n${instruction}`
              ).join('\n\n') : 'N/A'}
              
              ### ðŸ“… Timeline
              ${plan.timeline || 'N/A'}
              
              ### âœ… Erfolgskriterien
              ${plan.success_criteria ? plan.success_criteria.map(c => `- [ ] ${c}`).join('\n') : 'N/A'}
              
              ---
              *Generiert von Master Orchestrator mit DeepSeek AI*`,
              labels: ['master-bot', 'ai-coordination', 'strategic-plan']
            });

  # ============================================================
  # Status Monitoring - Kontinuierliche Ãœberwachung
  # ============================================================
  monitor:
    name: ðŸ“Š Continuous Monitoring
    runs-on: ubuntu-latest
    needs: [master-control, execute-tasks]
    if: always()
    
    steps:
      - name: Update Dashboard
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            console.log('ðŸ“Š Dashboard wird aktualisiert...');
            
            // Suche nach Master-Dashboard-Issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'master-dashboard',
              state: 'open',
              per_page: 1
            });
            
            const dashboardContent = `## ðŸŽ¯ Master Bot Dashboard
            
            **Letztes Update:** ${new Date().toISOString()}
            **Status:** ${{ needs.master-control.outputs.action }}
            **Health:** ${{ needs.execute-tasks.result || 'pending' }}
            
            ### ðŸ”„ Letzte AktivitÃ¤ten
            - Event: ${{ github.event_name }}
            - Action: ${{ needs.master-control.outputs.action }}
            - Priority: ${{ needs.master-control.outputs.priority }}
            
            ### ðŸ“ˆ Metriken
            - Workflows: ${{ needs.master-control.result }}
            - Tasks: ${{ needs.execute-tasks.result }}
            
            ---
            *Auto-Update durch Master Orchestrator*`;
            
            if (issues.length === 0) {
              // Erstelle Dashboard
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸŽ¯ Master Bot Dashboard',
                body: dashboardContent,
                labels: ['master-dashboard', 'pinned']
              });
            } else {
              // Update existierendes Dashboard
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: dashboardContent
              });
            }
